
# --- 全局配置参数 (Global Configuration) ---
# LM Studio 连接配置
LM_STUDIO_API_BASE = "http://192.168.30.190:1234/v1"
LM_STUDIO_API_KEY = "lm-studio"

# 模型配置
EMBEDDING_MODEL_NAME = "text-embedding-bge-m3"
CHAT_MODEL_NAME = "qwen/qwen3-4b-2507"

# 路径配置
DB_PERSIST_DIR = r"D:\DM\LangChain\联络名单-Agent\Quotation_agent\chroma_db"
MASTER_JSON_PATH = r"D:\DM\LangChain\联络名单-Agent\Quotation_agent\json_save\unified_data.json"
JSON_DATA_PATH = MASTER_JSON_PATH


# RAG 检索参数
RETRIEVAL_K = 10 #模型上下文限制为40000
CHUNK_OVERLAP = 0 # 这里的Chunk是基于Excel行的，没有重叠

# 评估配置
ENABLE_RAGAS_EVALUATION = False # 是否开启 Ragas 评估，设为 False 可跳过评估步骤以节省时间和避免超时

# 默认场景配置 
DEFAULT_SCENARIO = "企业联络名单"

# --- 统一 Prompt 管理 ---
class Prompts:
    # 1. 意图识别
    INTENT_CLASSIFICATION = """
你是一个智能意图识别助手。当前服务的业务场景为：【{scenario}】。
请根据该场景背景，判断用户问题的类型。

用户问题: {question}

类型定义：
1. SQL (结构化查询): 涉及对数据库中具体字段的统计、计算、排序或精确筛选。
    - 特征：通常包含"多少"、"总和"、"平均"、"最大/最小"、"大于/小于"、"列出...的详情"等明确的数据操作指令，或者**查询特定实体的属性值**。
    - 示例："{scenario}中有多少条记录？"、"统计各部门人数"、"列出价格高于100的产品"、"张三的邮箱是什么"。
 2. RAG (知识检索): 涉及对非结构化文档、描述性文本或背景知识的查询。
    - 特征：通常询问"是什么"、"介绍一下"、"背景"、"流程"、"原因"等语义理解类问题。
    - 示例："介绍一下项目背景"、"如何处理退款流程"、"某人的主要职责是什么"。

请只返回类型名称（SQL 或 RAG），不要包含其他文字。
"""

    # 2. SQL 生成
    SQL_GENERATION = """
你是一个智能SQL生成专家。你的任务是根据用户的自然语言问题，结合表结构信息，生成准确的SQLite查询语句。

当前场景数据表信息：
- 表名: {table_name}
- 可用列名 (Schema): {columns}

[历史对话]
{history}

用户问题: {question}

生成规则：
1. **字段映射**：请仔细分析用户问题中的业务术语，并将其映射到最匹配的数据库列名。例如，用户说"部门"可能对应 `dept_name` 或 `department`，"产品"可能对应 `prod_name`。
2. **查询策略**：
   - **明细查询**：如果用户询问"哪些"、"谁"、"列出"、"详细信息"或特定属性（如"价格大于100的订单"），请**查询具体的列**（选择最能代表实体信息的列，如姓名、名称、ID等），不要使用 COUNT(*)。
   - **统计查询**：仅当用户明确只询问"数量"、"多少个"（如"有多少人"、"总销量是多少"）且不需要具体名单时，才使用 COUNT(*) 或 SUM() 等聚合函数。
   - **混合查询**：如果用户同时询问数量和详情（如"有多少个异常订单，列出来"），请**只查询具体数据列**。后续步骤会负责统计数量。
3. **语法规范**：
   - 仅返回纯文本 SQL 语句，不要使用 Markdown 格式（不要 ```sql）。
   - 使用标准 SQLite 语法。
   - 模糊搜索请使用 `LIKE '%keyword%'`。

SQL语句:
"""

    # 3. SQL 结果回答
    SQL_ANSWER = """
用户问题: {question}
执行的SQL: {sql}
查询结果:
{result_str}

请根据上述查询结果，以自然、流畅的语言回答用户问题。
1. **数据解读**：直接基于查询结果回答。如果结果是列表且用户问数量，请手动统计行数并回答（例如"共找到 N 条记录..."）。
2. **信息展示**：如果用户要求列出详情，请条理清晰地列出结果中的关键信息。
3. **空结果处理**：如果结果为空，请友好地告知用户未找到符合条件的数据。
4. **通用性**：请根据实际数据内容回答，不要假设数据一定是"人员"或"名单"，它可能是订单、产品、日志等任何业务实体。
"""

    # 4. RAG 检索判断 - System
    RAG_JUDGMENT_SYSTEM = """
你是一个智能检索助手。你的任务是判断提供的参考资料是否包含回答用户问题的完整信息。
严格遵守以下规则：
1. **禁止幻觉**：如果你在资料中找不到用户查询的确切ID、编号、姓名或关键词，**绝对不要**尝试猜测或使用仅仅是"看起来像"的数据，严禁强行关联。
2. **多轮检索**：如果当前资料不足或不匹配，请优先选择 "SEARCH_MORE" 并生成新的查询词，而不是直接 "GIVE_UP"。只有当你确定换个词也搜不到（比如已尝试过多种变体）时才放弃。
3. **精准匹配**：对于代码、订单号、款号等实体，必须精确匹配。
"""

    # 5. RAG 检索判断 - User
    RAG_JUDGMENT_USER = """
[历史对话]
{history}

[用户问题]
{question}

[已累积的线索]
{accumulated_clues}

[当前批次参考资料]
{context_block}

请仔细分析并按以下格式输出之一：

情况 1：资料足以完整回答问题
STATUS: SOLVED
CONTENT: [你的最终答案]

情况 2：资料不足，需要进一步检索
STATUS: SEARCH_MORE
CLUES: [从当前资料中提取的新线索总结，如果无新线索填"无"]
NEXT_QUERY: [用于查找缺失信息的新的搜索关键词，简短精确]

情况 3：资料不足且无法构造有效的新查询（已尽力）
STATUS: GIVE_UP
CLUES: [总结已知信息]

注意：
- NEXT_QUERY 应该是针对缺失信息的具体关键词（例如"营运部 人员名单" 或 "张三 职位"）。
- 不要再次搜索已经搜索过的词。
"""

    # 6. RAG 最终总结
    RAG_SUMMARY = """
[历史对话]
{history}

用户问题：{question}
已收集的线索：
{clues}

请基于上述线索，尝试回答问题。
重要原则：
1. 如果根据线索可以回答问题，请提供直接的答案。
2. 如果线索不足以回答，或者找不到相关信息，请严格只回答一句："根据知识库内容无法提供回答"，不要包含"已知相关信息"、"结论"或其他解释。
"""

    # 7. Excel 表头识别
    HEADER_IDENTIFICATION = """
你是一个专业的Excel数据分析助手。请分析以下Excel工作表的前20行数据，找出包含列名（表头）的那一行。
通常表头行包含描述性的字段名称（如"姓名"、"电话"、"地址"等）。

数据预览：
{preview_text}

请直接返回表头所在的行号（从0开始计数）。
只返回一个数字，不要包含任何其他文字或解释。
如果无法确定，请返回 0。
"""
